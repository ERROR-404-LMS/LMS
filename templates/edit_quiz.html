<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Quiz</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #DFD3C3;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .form-wrapper {
            width: 100%;
            max-width: 800px;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            margin: 20px;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
        }

        input, select, textarea {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            margin-bottom: 10px;
        }

        button {
            width: 100%;
            padding: 10px;
            background-color: #8B4513;
            border: none;
            color: #fff;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }

        button:hover {
            background-color: #A0522D;
        }

        .options-container label {
            display: block;
            margin-bottom: 5px;
        }

        .options-container input {
            margin-bottom: 5px;
        }

        .true-false-container,
        .fill-in-blank-container {
            margin-top: 10px;
        }

        .question-container {
            margin-bottom: 20px;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="form-wrapper">
        <h1>Edit Quiz</h1>
        <form method="post" id="editQuizForm" enctype="multipart/form-data">
            <input type="hidden" name="quiz_id" value="{{ quiz.id }}">

            <div class="container">
                <label for="name">Quiz Name:</label>
                <input type="text" name="name" id="name" value="{{ quiz.name }}">
                <label for="description">Quiz Description:</label>
                <textarea name="description" id="description">{{ quiz.description }}</textarea>
            </div>

            <div id="questions-container">
                <!-- Existing questions loop -->
                {% for question in quiz_questions %}
                <div class="container question-container" id="question{{ question.id }}">
                    <label for="questionText{{ question.id }}">Question Text:</label>
                    <textarea name="questionText{{ question.id }}" id="questionText{{ question.id }}">{{ question.question_text }}</textarea>

                    <label for="questionType{{ question.id }}">Question Type:</label>
                    <select name="questionType{{ question.id }}" id="questionType{{ question.id }}" onchange="handleQuestionTypeChange(this)">
                        <option value="multiple" {% if question.question_type == 'multiple' %} selected {% endif %}>Multiple Choice</option>
                        <option value="true_false" {% if question.question_type == 'true_false' %}selected{% endif %}>True/False</option>
                        <option value="fill_in_blank" {% if question.question_type == 'fill_in_blank' %}selected{% endif %}>Fill in the Blank</option>
                    </select>

                    <div class="options-container" id="optionsContainer{{ question.id }}" {% if question.question_type != 'multiple' %}style="display:none;"{% endif %}>
                        <label>Choices:</label>
                        {% for i, option in enumerate(question.options | json_loads) %}
                        <input type="text" name="choice{{ question.id }}{{ i + 1 }}" id="choice{{ question.id }}{{ i + 1 }}" value="{{ option }}" placeholder="Choice {{ i + 1 }}">
                        {% endfor %}
                        <label for="correct_answer{{ question.id }}">Correct Answer:</label>
                        <select name="correct_answer{{ question.id }}" id="correct_answer{{ question.id }}">
                            {% for i, option in enumerate(question.options | json_loads) %}
                            <option value="{{ i + 1 }}" {% if question.correct_answer == option %}selected{% endif %}>Choice {{ i + 1 }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="true-false-container" id="trueFalseContainer{{ question.id }}" {% if question.question_type != 'true_false' %}style="display:none;"{% endif %}>
                        <label for="trueFalse{{ question.id }}">Correct Answer:</label>
                        <select name="trueFalse{{ question.id }}" id="trueFalse{{ question.id }}">
                            <option value="true" {% if question.correct_answer == 'true' %}selected{% endif %}>True</option>
                            <option value="false" {% if question.correct_answer == 'false' %}selected{% endif %}>False</option>
                        </select>
                    </div>
                    <div class="fill-in-blank-container" id="fillInBlankContainer{{ question.id }}" {% if question.question_type != 'fill_in_blank' %}style="display:none;"{% endif %}>
                        <label for="fill_in_blank{{ question.id }}">Correct Answer:</label>
                        <input type="text" name="fill_in_blank{{ question.id }}" id="fill_in_blank{{ question.id }}" value="{{ question.correct_answer }}">
                    </div>
                    <button type="button" class="delete-question-button" onclick="deleteQuestion({{ question.id }})">Delete Question</button>
                </div>
                {% endfor %}
            </div>

            <button type="button" class="add-question-button" onclick="addQuestion()">Add Question</button>
            <button type="submit" onclick="submitForm()">Save Changes</button>
        </form>
    </div>

    <script>
let questionCount = {{ quiz_questions|length }}; // Get initial question count

function handleQuestionTypeChange(selectElement) {
    const questionId = selectElement.id.replace('questionType', '');
    const optionsContainer = document.getElementById(`optionsContainer${questionId}`);
    const trueFalseContainer = document.getElementById(`trueFalseContainer${questionId}`);
    const fillInBlankContainer = document.getElementById(`fillInBlankContainer${questionId}`);

    if (selectElement.value === 'true_false') {
        optionsContainer.style.display = 'none';
        trueFalseContainer.style.display = 'block';
        fillInBlankContainer.style.display = 'none';
    } else if (selectElement.value === 'multiple') {
        optionsContainer.style.display = 'block';
        trueFalseContainer.style.display = 'none';
        fillInBlankContainer.style.display = 'none';
    } else if (selectElement.value === 'fill_in_blank') {
        optionsContainer.style.display = 'none';
        trueFalseContainer.style.display = 'none';
        fillInBlankContainer.style.display = 'block';
    } else {
        optionsContainer.style.display = 'none';
        trueFalseContainer.style.display = 'none';
        fillInBlankContainer.style.display = 'none';
    }
}

// Initial setup
document.addEventListener('DOMContentLoaded', function() {
  // Trigger change event for each question type select element
  document.querySelectorAll('select[name^="questionType"]').forEach(select => {
    handleQuestionTypeChange(select);
  });
});


function addQuestion() {
    questionCount++;
    const questionsContainer = document.getElementById('questions-container');
    const newQuestionHTML = `
        <div class="container question-container" id="question${questionCount}">
            <label for="questionText${questionCount}">Question Text:</label>
            <textarea name="questionText${questionCount}" id="questionText${questionCount}"></textarea>

            <label for="questionType${questionCount}">Question Type:</label>
            <select name="questionType${questionCount}" id="questionType${questionCount}" onchange="handleQuestionTypeChange(this)">
                <option value="multiple">Multiple Choice</option>
                <option value="true_false">True/False</option>
                <option value="fill_in_blank">Fill in the Blank</option>
            </select>

            <div class="options-container" id="optionsContainer${questionCount}" style="display:none;">
                <label>Choices:</label>
                <input type="text" name="choice${questionCount}_1" id="choice${questionCount}_1" placeholder="Choice 1">
                <input type="text" name="choice${questionCount}_2" id="choice${questionCount}_2" placeholder="Choice 2">
                <input type="text" name="choice${questionCount}_3" id="choice${questionCount}_3" placeholder="Choice 3">
                <input type="text" name="choice${questionCount}_4" id="choice${questionCount}_4" placeholder="Choice 4">
                <label for="correct_answer${questionCount}">Correct Answer:</label>
                <select name="correct_answer${questionCount}" id="correct_answer${questionCount}">
                    <option value="1">Choice 1</option>
                    <option value="2">Choice 2</option>
                    <option value="3">Choice 3</option>
                    <option value="4">Choice 4</option>
                </select>
            </div>
            <div class="true-false-container" id="trueFalseContainer${questionCount}" style="display:none;">
                <label for="trueFalse${questionCount}">Correct Answer:</label>
                <select name="trueFalse${questionCount}" id="trueFalse${questionCount}">
                    <option value="true">True</option>
                    <option value="false">False</option>
                </select>
            </div>
            <div class="fill-in-blank-container" id="fillInBlankContainer${questionCount}" style="display:none;">
                <label for="fill_in_blank${questionCount}">Correct Answer:</label>
                <input type="text" name="fill_in_blank${questionCount}" id="fill_in_blank${questionCount}">
            </div>
            <button type="button" class="delete-question-button" onclick="deleteQuestion(${questionCount})">Delete Question</button>
        </div>
    `;
    questionsContainer.insertAdjacentHTML('beforeend', newQuestionHTML);
    // Initialize question type display
    handleQuestionTypeChange(document.getElementById(`questionType${questionCount}`));
}


function submitForm() {
    const form = document.getElementById('editQuizForm');
    const formData = new FormData(form);

    fetch('/add_question', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        alert(data.message); // Display success message or handle response
        // Optionally, reset the form or update UI as needed
    })
    .catch(error => {
        console.error('Error adding question:', error);
        alert('An error occurred while adding the question. Please try again.');
    });
}


        // Delete question functionality
        function deleteQuestion(questionId) {
            const confirmation = confirm('Are you sure you want to delete this question?');
            if (confirmation) {
                // Send AJAX request to delete question
                fetch(`/delete_question/${questionId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        // Add any necessary headers like CSRF token if required
                    },
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    // Remove question element from DOM
                    const questionElement = document.getElementById(`question${questionId}`);
                    if (questionElement) {
                        questionElement.remove();
                    }
                })
                .catch(error => {
                    console.error('Error deleting question:', error);
                    alert('An error occurred while deleting the question. Please try again.');
                });
            }
        }
    </script>
</body>
</html>
